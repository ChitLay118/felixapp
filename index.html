<body class="bg-f0f2f5 pb-20">

    <script type="module">
        // --------------------------------------------------------------------------------
        // 1. FIREBASE INITIALIZATION AND IMPORTS
        // --------------------------------------------------------------------------------

        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
        import { 
            getFirestore, doc, updateDoc, deleteDoc, 
            collection, query, where, orderBy, onSnapshot, addDoc, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
        import { 
            getAuth, onAuthStateChanged, 
            GoogleAuthProvider, signInWithPopup, signOut // <-- Google Login အတွက် ထည့်သွင်း
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";


        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAUL74mqVCIY1MMclrRhdVbY_VyP4lgQpY",
            authDomain: "waiappstore.firebaseapp.com",
            projectId: "waiappstore",
            storageBucket: "waiappstore.firebasestorage.app",
            messagingSenderId: "161610339691",
            appId: "1:161610339691:web:5f8e9fcd9706fda330682e",
            measurementId: "G-T3NWL0LXTT"
        };

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        
        // Initialize Database and Authentication for use in the app
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Google Provider setup
        const googleProvider = new GoogleAuthProvider(); // <-- Google Provider ဖန်တီး

        // Global variables 
        let currentEditAppId = null; 
        const APP_COLLECTION_PATH = 'apps';
        
        // Exporting to window for easy access
        window.db = db;
        window.auth = auth;
        window.allApps = [];
        window.isAdmin = false;
        
        // Get elements from the DOM
        const editAppForm = document.getElementById('editAppForm');
        const submitAppModal = document.getElementById('submitAppModal');
        const profileModal = document.getElementById('profileModal');
        const editAppModal = document.getElementById('editAppModal');
        const userDisplayBtn = document.getElementById('userDisplayBtn');
        const submitAppForm = document.getElementById('appSubmissionForm');
        const appListContainer = document.getElementById('appListContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const viewTitle = document.getElementById('viewTitle');
        const noResults = document.getElementById('noResults');
        const loginContainer = document.getElementById('loginContainer'); // <-- အသစ်
        const logoutContainer = document.getElementById('logoutContainer'); // <-- အသစ်
        
        // --------------------------------------------------------------------------------
        // 2. AUTHENTICATION FUNCTIONS (Google Sign-in/out)
        // --------------------------------------------------------------------------------

        // Google Sign In
        window.signInWithGoogle = async () => {
            try {
                // Pop-up ဖြင့် ဝင်ရောက်ခြင်း
                await signInWithPopup(auth, googleProvider); 
                window.showToast("Google ဖြင့် ဝင်ရောက်ခြင်း အောင်မြင်ပါသည်။", 'success');
                profileModal.classList.add('hidden'); // Modal ပိတ်ခြင်း
            } catch (error) {
                console.error("Google Sign-In Error: ", error);
                window.showToast("Google ဖြင့် ဝင်ရောက်ရာတွင် အမှားဖြစ်ခဲ့သည်။", 'error');
            }
        };

        // Sign Out
        window.signOutUser = async () => {
            try {
                await signOut(auth);
                window.showToast("အောင်မြင်စွာ ထွက်ပြီးပါပြီ။", 'info');
                profileModal.classList.add('hidden');
                window.isAdmin = false; // Log out လုပ်ရင် Admin status ကိုလည်း ဖြုတ်
            } catch (error) {
                console.error("Sign-Out Error: ", error);
                window.showToast("ထွက်ရာတွင် အမှားဖြစ်ခဲ့သည်။", 'error');
            }
        };


        // --------------------------------------------------------------------------------
        // 3. CORE APPLICATION LOGIC (UI/Data)
        // --------------------------------------------------------------------------------
        
        // ... (window.filterApps, window.setView, window.setCategoryFilter functions များ မပြောင်းလဲပါ) ...
        
        // Placeholder for rendering apps (creates the HTML cards)
        window.renderApps = (apps) => {
            // ... (window.renderApps function အရင်အတိုင်း) ...
            appListContainer.innerHTML = apps.map(app => `
                <div class="app-card bg-white p-4 rounded-xl shadow-play hover:shadow-lg transition cursor-pointer" onclick="window.handleAppClick('${app.id}')">
                    <img src="${app.iconUrl}" alt="${app.name} icon" class="w-16 h-16 rounded-xl mx-auto mb-3 object-cover">
                    <p class="text-sm font-bold text-gray-800 truncate text-center">${app.name}</p>
                    <p class="text-xs text-gray-500 text-center">${app.category}</p>
                    ${window.isAdmin ? `
                        <div class="mt-2 text-center">
                            <button onclick="event.stopPropagation(); window.openEditModal('${app.id}')" 
                                class="text-xs text-yellow-600 hover:text-yellow-700 font-semibold">
                                Edit
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');

            loadingIndicator.classList.add('hidden');
        };

        // ... (window.openEditModal, window.handleAppClick functions များ မပြောင်းလဲပါ) ...

        // Update Profile UI (Auth Status ပြောင်းလဲတိုင်း အလုပ်လုပ်)
        window.updateProfileUI = () => {
            const user = auth.currentUser;
            const profileAvatarInitials = document.getElementById('profileAvatarInitials');
            const profileDisplayName = document.getElementById('profileDisplayName');
            const profileDisplayEmail = document.getElementById('profileDisplayEmail');
            const currentUserIdSpan = document.getElementById('currentUserIdSpan');
            const submitterNameInput = document.getElementById('submitterNameInput');
            const submitterEmailInput = document.getElementById('submitterEmailInput');
            const profileEditSection = document.getElementById('profileEditSection'); // <-- အသစ်

            if (user) {
                // User Logged In 
                const name = user.displayName || user.email.split('@')[0]; // Google မှာ နာမည်မရှိရင် email ကနေ ယူ
                const email = user.email || 'No Email';
                
                profileDisplayName.textContent = name;
                profileDisplayEmail.textContent = email;
                profileAvatarInitials.textContent = name.charAt(0).toUpperCase();
                currentUserIdSpan.textContent = user.uid;

                submitterNameInput.value = name;
                submitterEmailInput.value = email;

                userDisplayBtn.textContent = name.charAt(0).toUpperCase();
                
                loginContainer.classList.add('hidden');    // Login ခလုတ် ဖျောက်
                logoutContainer.classList.remove('hidden'); // Logout ခလုတ် ပြ
                profileEditSection.classList.add('hidden'); // Profile ပြင်ဆင်ရန် အပိုင်း ဖျောက် (Google ဖြင့်မရ)

            } else {
                // User Logged Out (Guest)
                profileDisplayName.textContent = 'ဧည့်သည် (Guest)';
                profileDisplayEmail.textContent = 'Google ဖြင့် ဝင်ရောက်ပါ';
                profileAvatarInitials.textContent = 'G';
                currentUserIdSpan.textContent = 'N/A';
                
                userDisplayBtn.textContent = '?';
                submitterNameInput.value = 'အမည်မသိ';
                submitterEmailInput.value = 'Email မရှိ';
                
                loginContainer.classList.remove('hidden'); // Login ခလုတ် ပြ
                logoutContainer.classList.add('hidden');  // Logout ခလုတ် ဖျောက်
                profileEditSection.classList.add('hidden'); // Profile ပြင်ဆင်ရန် အပိုင်း ဖျောက်
            }

            // Admin Panel Visibility (Admin Logic အရင်အတိုင်း)
            const adminPanelStatus = document.getElementById('adminPanelStatus');
            const adminLoginContainer = document.getElementById('adminLoginContainer');
            
            if (window.isAdmin) {
                adminPanelStatus.classList.remove('hidden');
                adminLoginContainer.classList.add('hidden');
            } else {
                adminPanelStatus.classList.add('hidden');
                adminLoginContainer.classList.remove('hidden');
            }
        };

        // ... (window.attemptAdminLogin, window.logoutAdmin, window.confirmAndDelete functions များ မပြောင်းလဲပါ) ...

        // --- 4. FIREBASE LISTENERS ---
        
        // Real-time listener for the apps collection (အရင်အတိုင်း)
        const appQuery = query(collection(db, APP_COLLECTION_PATH), orderBy("timestamp", "desc"));

        onSnapshot(appQuery, (snapshot) => {
            window.allApps = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            window.filterApps(); 
            loadingIndicator.classList.add('hidden');
        }, (error) => {
            // ... (Error handling အရင်အတိုင်း) ...
        });

        // Real-time listener for Auth State (User Login/Logout)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUser = user;
                // Google ဖြင့် ဝင်ရောက်လျှင် DisplayName သည် Google မှ အလိုအလျောက်ရရှိ
                window.showToast(`${user.displayName || user.email} အဖြစ် ဝင်ရောက်ထားသည်။`, 'info'); 
            } else {
                window.currentUser = null;
            }
            window.updateProfileUI(); // UI ကို အမြဲ Update လုပ်
            window.filterApps();
        });

        // --- 5. FORM SUBMISSION LOGIC (Create/Update/Delete) ---

        // User: Submit New App Logic (အရင်အတိုင်း)
        submitAppForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!auth.currentUser || !db) {
                window.showToast("App တင်သွင်းရန်အတွက် Google ဖြင့် ဝင်ရန် လိုအပ်ပါသည်။", 'error');
                return;
            }
            // ... (rest of the submission logic) ...
            try {
                // ... (addDoc logic) ...
            } catch (error) {
                // ... (error handling) ...
            }
        });

        // Admin: Update App Logic (အရင်အတိုင်း)
        editAppForm.addEventListener('submit', async (e) => {
            // ... (Update Logic အရင်အတိုင်း) ...
        });
        
        // ... (window.confirmAndDelete function အရင်အတိုင်း) ...
        
        // --- 6. MODAL AND UTILITY FUNCTIONS ---

        // ... (Modal Toggling functions အရင်အတိုင်း) ...

        // Toast Notification (အရင်အတိုင်း)
        window.showToast = function(message, type = 'info') {
            // ... (Toast Logic အရင်အတိုင်း) ...
        }

        // Initial setup on window load (အရင်အတိုင်း)
        window.onload = () => {
            lucide.createIcons(); 
            window.setView('all'); 
            window.setCategoryFilter('All', false); 
            document.getElementById('searchInput').oninput = window.filterApps;
        };
        
    </script>
    
    <div id="profileModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto modal-content">
            <div class="flex justify-between items-center border-b pb-3 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                    <i data-lucide="user-circle" class="w-6 h-6 mr-2 text-active-blue"></i>
                    သုံးစွဲသူ Profile
                </h2>
                <button id="closeProfileModalBtn" class="text-gray-400 hover:text-gray-600 transition" title="ပိတ်ရန်">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="text-center mb-6 p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center justify-center w-16 h-16 rounded-full bg-play-green text-white font-bold text-xl mx-auto shadow-lg mb-3">
                    <span id="profileAvatarInitials">U</span>
                </div>
                <h3 id="profileDisplayName" class="text-xl font-bold text-gray-800"></h3>
                <p id="profileDisplayEmail" class="text-gray-500 text-sm"></p>
                <p class="text-xs text-gray-400 mt-2">User ID: <span id="currentUserIdSpan">...</span></p>
            </div>

            <div id="loginContainer" class="space-y-4">
                <h3 class="text-md font-bold text-gray-700 mb-3 border-t pt-4">ဝင်ရောက်ခြင်း / မှတ်ပုံတင်ခြင်း</h3>
                <button onclick="window.signInWithGoogle()"
                            class="w-full py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 active:bg-red-800 transition duration-150 shadow-lg flex items-center justify-center space-x-2">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/4/4a/Logo-google.png" alt="Google Logo" class="w-5 h-5 bg-white rounded-full">
                    <span>Google ဖြင့် ဝင်ရောက်ရန်</span>
                </button>
            </div>

            <div id="logoutContainer" class="hidden space-y-4">
                <button onclick="document.getElementById('profileModal').classList.add('hidden'); window.setView('mine');"
                            class="w-full mb-6 py-3 border border-active-blue text-active-blue font-bold rounded-lg hover:bg-active-blue hover:text-white active:bg-blue-700 transition duration-150">
                    <i data-lucide="app-window" class="w-5 h-5 inline mr-2"></i>
                    ကျွန်ုပ်တင်ထားသော App များကိုကြည့်ရန်
                </button>

                <button onclick="window.signOutUser()"
                            class="w-full py-3 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 active:bg-gray-500 transition duration-150 shadow-lg mt-4">
                    <i data-lucide="log-out" class="w-5 h-5 inline mr-2"></i>
                    ထွက်ရန် (Sign Out)
                </button>
            </div>
            
            <div id="profileEditSection" class="hidden">
                </div>
            
            <div class="mt-8 pt-4 border-t border-gray-200" id="adminPanel">
                </div>
            
        </div>
    </div>
    
    </body>
</html>
